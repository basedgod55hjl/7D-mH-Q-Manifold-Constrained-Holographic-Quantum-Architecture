// 7D Translated Source
// Generated by 7D Rewrite Engine v1.0
// Sovereignty: ENABLED

cmake_minimum_required(VERSION 3.25 FATAL_ERROR)

project(CORE_PC_UNIFIED 
    VERSION 1.0.0
    LANGUAGES C CXX CUDA
)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CUDA_STANDARD 17)
set(CMAKE_CUDA_STANDARD_REQUIRED ON)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Build options
option(BUILD_CUDA "Build CUDA kernels (NVIDIA)" ON)
option(BUILD_HIP "Build HIP kernels (AMD)" OFF)
option(BUILD_TESTS "Build integration tests" OFF)
option(BUILD_SHARED "Build shared libraries" ON)

# Compiler flags
if(MSVC)
    set(CMAKE_CXX_FLAGS_RELEASE "/O2 /DNDEBUG")
else()
    set(CMAKE_CXX_FLAGS_RELEASE "-O3 -march=native -DNDEBUG")
endif()
set(CMAKE_CUDA_FLAGS "-O3 --use_fast_math -Wno-deprecated-gpu-targets")

# Find required packages
find_package(CUDAToolkit 12.0 REQUIRED)

# TensorRT (user must set TENSORRT_DIR)
if(DEFINED ENV{TENSORRT_DIR})
    set(TENSORRT_DIR $ENV{TENSORRT_DIR})
    find_library(TENSORRT_LIB nvinfer PATHS ${TENSORRT_DIR}/lib NO_DEFAULT_PATH)
    if(TENSORRT_LIB)
        message(STATUS "Found TensorRT: ${TENSORRT_DIR}")
        include_directories(${TENSORRT_DIR}/include)
        link_directories(${TENSORRT_DIR}/lib)
    else()
        message(WARNING "TensorRT library not found. TensorRT features disabled.")
    endif()
else()
    message(WARNING "TENSORRT_DIR not set. TensorRT features disabled.")
endif()

# Include directories
include_directories(${PROJECT_SOURCE_DIR}/cpp/include)
include_directories(${PROJECT_SOURCE_DIR}/cuda/include)
include_directories(${PROJECT_SOURCE_DIR}/lib/cccl/libcudacxx/include)
include_directories(${PROJECT_SOURCE_DIR}/lib/cccl/thrust)
include_directories(${PROJECT_SOURCE_DIR}/lib/cccl/cub)

# Subdirectories
add_subdirectory(cuda)
add_subdirectory(cpp)
add_subdirectory(trtllm_custom_plugins)

# Cross-platform ROCm/HIP support
include(cmake/ROCmSupport.cmake)

if(BUILD_HIP)
    add_subdirectory(hip)
endif()

if(BUILD_TESTS)
    enable_testing()
    add_subdirectory(tests)
endif()

# Install rules
install(DIRECTORY ${CMAKE_BINARY_DIR}/lib/ 
    DESTINATION ${PROJECT_SOURCE_DIR}/lib
    FILES_MATCHING PATTERN "*.so" PATTERN "*.dll" PATTERN "*.a" PATTERN "*.lib"
)

message(STATUS "=== CORE PC Build Configuration ===")
message(STATUS "CUDA: ${CUDAToolkit_VERSION}")
if(TENSORRT_LIB)
    message(STATUS "TensorRT: ${TENSORRT_DIR}")
else()
    message(STATUS "TensorRT: Not found")
endif()
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
