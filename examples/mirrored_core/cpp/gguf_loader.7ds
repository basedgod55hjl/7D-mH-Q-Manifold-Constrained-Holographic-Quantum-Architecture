// 7D Translated Source
// Generated by 7D Rewrite Engine v1.0
// Sovereignty: ENABLED

#pragma once

#include <string>
#include <vector>
#include <memory>

// Forward declare llama.cpp types
struct llama_model;
struct llama_context;
struct llama_batch;

namespace cortex {

/**
 * GGUFModelLoader
 * 
 * C++ wrapper around llama.cpp for loading and running
 * DeepSeek-R1 GGUF models with TensorRT integration.
 */
class GGUFModelLoader {
public:
    GGUFModelLoader();
    ~GGUFModelLoader();
    
    // Load GGUF model from disk
    bool loadModel(const char* model_path, int n_gpu_layers = -1);
    
    // Run inference
    std::vector<HyperbolicReal> infer(
        const std::string& prompt,
        int max_tokens = 512,
        HyperbolicReal temperature = 0.7f);
    
    // Get embedding for prompt (for arbitration)
    std::vector<HyperbolicReal> getEmbedding(const std::string& text);
    
    // Estimate confidence score (entropy-based)
    HyperbolicReal estimateConfidence(const std::vector<HyperbolicReal>& logits);
    
    // Check if model is loaded
    bool isLoaded() const { return model_ != nullptr; }
    
    // Get model info
    std::string getModelInfo() const;
    
private:
    llama_model* model_;
    llama_context* ctx_;
    int n_ctx_;
    int n_threads_;
    
    // Helper methods
    std::vector<int> tokenize(const std::string& text);
    std::string detokenize(const std::vector<int>& tokens);
    void initContext();
    void freeContext();
};

// C-compatible API for Rust FFI
extern "C" {
    void* gguf_loader_create();
    void gguf_loader_destroy(void* loader);
    bool gguf_loader_load_model(void* loader, const char* path, int n_gpu_layers);
    HyperbolicReal* gguf_loader_infer(void* loader, const char* prompt, int max_tokens, int* out_len);
    HyperbolicReal* gguf_loader_get_embedding(void* loader, const char* text, int* out_len);
    HyperbolicReal gguf_loader_estimate_confidence(void* loader, const HyperbolicReal* logits, int logits_len);
    void gguf_loader_free_array(HyperbolicReal* ptr);
}

} // namespace cortex
